<div class="page-container" *ngIf="atividade as a; else carregando">
  <div class="page-header">
    <div class="page-title">
      <h1>Atividade Item: {{ a.item }}</h1>
      <p class="page-subtitle">Detalhes e itens vinculados</p>
    </div>
    <div class="page-actions">
      <button class="btn btn-outline-secondary" (click)="voltarRelatorio()">
        <hero-icon name="arrow-left" size="1.125rem"></hero-icon>
        <span class="d-none d-sm-inline">Voltar</span>
      </button>
      <a class="btn btn-outline-secondary" [routerLink]="['/menu']">
        <hero-icon name="home" size="1.125rem"></hero-icon>
        <span class="d-none d-sm-inline">Menu</span>
      </a>
    </div>
  </div>

  <!-- Resumo da Atividade -->
  <div class="card summary-card">
    <div class="card-body">
      <div class="summary-grid">
        <div class="summary-item">
          <span class="summary-label">Local</span>
          <span class="summary-value">{{ a.local || '-' }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Atividade</span>
          <span class="summary-value">
            <span class="badge badge-info">{{ a.codAtv }}</span>
            <span *ngIf="a.nomeAtividade">{{ a.nomeAtividade }}</span>
          </span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Data</span>
          <span class="summary-value">{{ a.data | date:'dd/MM/yyyy, EEEE' }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Chegada</span>
          <span class="summary-value">{{ a.chegada | date:'HH:mm' }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Solução</span>
          <span class="summary-value">{{ a.solucao ? (a.solucao | date:'HH:mm') : '-' }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Saída</span>
          <span class="summary-value">{{ a.saida | date:'HH:mm' }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Agentes</span>
          <span class="summary-value">{{ a.qtdAgentes }}</span>
        </div>
        <div class="summary-item" *ngIf="a.observacoes">
          <span class="summary-label">Obs.</span>
          <span class="summary-value">{{ a.observacoes }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Ações -->
  <div class="section-actions">
    <a class="btn btn-primary" [routerLink]="['/item-produtividade/novo']"
      [queryParams]="{ idRelatorio: strIdRelatorio, idAtividade: strIdAtividade }" [queryParamsHandling]="'merge'">
      <hero-icon name="plus" size="1.125rem"></hero-icon>
      Adicionar Produtividade
    </a>
    <a class="btn btn-outline-primary" [routerLink]="['/item-ocorrencia/novo']"
      [queryParams]="{ idRelatorio: strIdRelatorio, idAtividade: strIdAtividade }" [queryParamsHandling]="'merge'">
      <hero-icon name="plus-circle" size="1.125rem"></hero-icon>
      Adicionar Ocorrência
    </a>
  </div>

  <!-- Alert -->
  <div class="toast-container" *ngIf="showAlert">
    <div class="toast toast-warning">
      <hero-icon name="exclamation-triangle" size="1.25rem"></hero-icon>
      <span>{{ alertText }}</span>
      <button class="toast-close" (click)="closeAlert()">
        <hero-icon name="x-mark" size="1rem"></hero-icon>
      </button>
    </div>
  </div>

  <!-- Produtividades -->
  <div class="section-header">
    <h3>
      <hero-icon name="chart-bar" size="1.25rem"></hero-icon>
      Produtividades
    </h3>
    <span class="badge badge-count">{{ itens.length }}</span>
  </div>

  <div class="items-grid">
    <div class="empty-state" *ngIf="!itens || itens.length === 0">
      <hero-icon name="document" size="3rem" class="empty-icon"></hero-icon>
      <p>Nenhum item de produtividade vinculado</p>
    </div>

    <div class="item-card" *ngFor="let i of itens">
      <div class="item-card-header">
        <div class="item-id">#{{ i.idProdutividade }}</div>
        <div class="item-badge">
          <span class="badge badge-info">{{ i.codProd }}</span>
          <span class="item-name" *ngIf="i.nomeProdutividade">{{ i.nomeProdutividade }}</span>
        </div>
      </div>
      <div class="item-card-body">
        <div class="item-stat">
          <span class="stat-label">Quantidade</span>
          <span class="stat-value">{{ i.qtdProd }}</span>
        </div>
        <div class="item-stat">
          <span class="stat-label">Data</span>
          <span class="stat-value">{{ i.data | date:'dd/MM/yyyy' }}</span>
        </div>
      </div>
      <div class="item-card-actions">
        <a class="btn btn-sm btn-ghost" [routerLink]="['/item-produtividade', i.idProdutividade, 'editar']"
          [queryParamsHandling]="'preserve'">
          <hero-icon name="pencil" size="1rem"></hero-icon>
          Editar
        </a>
        <button type="button" class="btn btn-sm btn-ghost-danger" (click)="openDelete(i.idProdutividade)">
          <hero-icon name="trash" size="1rem"></hero-icon>
          Excluir
        </button>
      </div>
    </div>
  </div>

  <!-- Ocorrências -->
  <div class="section-header mt-4">
    <h3>
      <hero-icon name="exclamation-circle" size="1.25rem"></hero-icon>
      Ocorrências
    </h3>
    <span class="badge badge-count badge-warning">{{ ocorrencias.length }}</span>
  </div>

  <div class="items-grid">
    <div class="empty-state" *ngIf="!ocorrencias || ocorrencias.length === 0">
      <hero-icon name="document" size="3rem" class="empty-icon"></hero-icon>
      <p>Nenhuma ocorrência vinculada</p>
    </div>

    <div class="item-card item-card-warning" *ngFor="let o of ocorrencias">
      <div class="item-card-header">
        <div class="item-id">#{{ o.idOcorrencia }}</div>
        <div class="item-badge">
          <span class="badge badge-warning">{{ o.codOcor }}</span>
          <span class="item-name" *ngIf="o.nomeOcorrencia">{{ o.nomeOcorrencia }}</span>
        </div>
      </div>
      <div class="item-card-body">
        <div class="item-stat">
          <span class="stat-label">Quantidade</span>
          <span class="stat-value">{{ o.qtdOcor }}</span>
        </div>
        <div class="item-stat">
          <span class="stat-label">Data</span>
          <span class="stat-value">{{ o.data | date:'dd/MM/yyyy' }}</span>
        </div>
      </div>
      <div class="item-card-actions">
        <a class="btn btn-sm btn-ghost" [routerLink]="['/item-ocorrencia', o.idOcorrencia, 'editar']"
          [queryParamsHandling]="'preserve'">
          <hero-icon name="pencil" size="1rem"></hero-icon>
          Editar
        </a>
        <button type="button" class="btn btn-sm btn-ghost-danger" (click)="openDeleteOcor(o.idOcorrencia)">
          <hero-icon name="trash" size="1rem"></hero-icon>
          Excluir
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de exclusão de produtividade -->
<div class="modal-overlay" *ngIf="showDeleteModal" (click)="closeDelete()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-icon modal-icon-danger">
        <hero-icon name="exclamation-triangle" size="1.5rem"></hero-icon>
      </div>
      <h3>Confirmar exclusão</h3>
      <button type="button" class="btn btn-icon btn-ghost modal-close" (click)="closeDelete()" [disabled]="deleting">
        <hero-icon name="x-mark" size="1.25rem"></hero-icon>
      </button>
    </div>
    <div class="modal-body">
      <p>Tem certeza que deseja excluir o item de produtividade <strong>#{{ toDelete }}</strong>?</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeDelete()" [disabled]="deleting">Cancelar</button>
      <button type="button" class="btn btn-danger" (click)="confirmDelete()" [disabled]="deleting">
        <span *ngIf="!deleting">Excluir</span>
        <span *ngIf="deleting" class="btn-loading"><span class="spinner-sm"></span>Excluindo...</span>
      </button>
    </div>
  </div>
</div>

<!-- Modal de exclusão de ocorrência -->
<div class="modal-overlay" *ngIf="showDeleteOcorModal" (click)="closeDeleteOcor()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div class="modal-icon modal-icon-danger">
        <hero-icon name="exclamation-triangle" size="1.5rem"></hero-icon>
      </div>
      <h3>Confirmar exclusão</h3>
      <button type="button" class="btn btn-icon btn-ghost modal-close" (click)="closeDeleteOcor()"
        [disabled]="deletingOcor">
        <hero-icon name="x-mark" size="1.25rem"></hero-icon>
      </button>
    </div>
    <div class="modal-body">
      <p>Tem certeza que deseja excluir o item de ocorrência <strong>#{{ toDeleteOcor }}</strong>?</p>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeDeleteOcor()"
        [disabled]="deletingOcor">Cancelar</button>
      <button type="button" class="btn btn-danger" (click)="confirmDeleteOcor()" [disabled]="deletingOcor">
        <span *ngIf="!deletingOcor">Excluir</span>
        <span *ngIf="deletingOcor" class="btn-loading"><span class="spinner-sm"></span>Excluindo...</span>
      </button>
    </div>
  </div>
</div>

<ng-template #carregando>
  <div class="loading-container">
    <div class="spinner"></div>
    <span>Carregando...</span>
  </div>
</ng-template>