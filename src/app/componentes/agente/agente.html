<div class="container py-3">
  <div class="row g-3 mb-2 align-items-center">
    <div class="col">
      <h2 class="h4 mb-0">Agentes</h2>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-12 col-md-6">
      <div class="input-group">
        <span class="input-group-text"><i class="mdi mdi-magnify"></i></span>
        <input type="text" class="form-control" [(ngModel)]="filtro" (ngModelChange)="onFilterChange()" name="filtro" placeholder="Buscar por nome, matrícula, cargo ou gerência" />
        <button class="btn btn-header" type="button" (click)="clearFilter()" [disabled]="!filtro" aria-label="Limpar filtro">
          <i class="mdi mdi-close-circle-outline"></i>
        </button>
      </div>
    </div>
    <div class="col-12 col-md-6 text-md-end">
      <a class="btn btn-outline-secondary me-2" routerLink="/menu"><i class="mdi mdi-arrow-left me-1"></i>Voltar ao Menu</a>
      <a class="btn btn-primary" [routerLink]="['/agente/novo']"><i class="mdi mdi-account-plus-outline me-1"></i>Novo Agente</a>
    </div>
  </div>

  <!-- Spinner de carregamento -->
  <div *ngIf="loading" class="d-flex justify-content-center align-items-center py-5" role="status" aria-live="polite">
    <div class="spinner-border text-primary me-2" role="status" aria-hidden="true"></div>
    <span>Carregando...</span>
  </div>

  <ng-container *ngIf="!loading">
  <div class="table-responsive shadow-sm">
    <table class="table table-striped table-hover align-middle mb-0">
      <colgroup>
        <col class="col-matricula" />
        <col />
        <col class="col-cargo" />
        <col class="col-turno" />
        <col class="col-gerencia" />
        <col class="col-acoes" />
      </colgroup>
      <thead class="table-light">
        <tr>
          <th class="th-nowrap">
            <button type="button" class="btn btn-link p-0 text-decoration-none" (click)="setSort('matricula')">
              <span [class.fw-semibold]="sortKey==='matricula'">Matrícula</span>
              <i class="mdi" [ngClass]="sortKey==='matricula' ? (sortDir==='asc' ? 'mdi-arrow-up' : 'mdi-arrow-down') : 'mdi-arrow-up-down'"></i>
            </button>
          </th>
          <th class="th-nowrap">
            <button type="button" class="btn btn-link p-0 text-decoration-none" (click)="setSort('nome')">
              <span [class.fw-semibold]="sortKey==='nome'">Nome</span>
              <i class="mdi" [ngClass]="sortKey==='nome' ? (sortDir==='asc' ? 'mdi-arrow-up' : 'mdi-arrow-down') : 'mdi-arrow-up-down'"></i>
            </button>
          </th>
          <th class="th-nowrap">
            <button type="button" class="btn btn-link p-0 text-decoration-none" (click)="setSort('cargo')">
              <span [class.fw-semibold]="sortKey==='cargo'">Cargo</span>
              <i class="mdi" [ngClass]="sortKey==='cargo' ? (sortDir==='asc' ? 'mdi-arrow-up' : 'mdi-arrow-down') : 'mdi-arrow-up-down'"></i>
            </button>
          </th>
          <th class="th-nowrap">
            <button type="button" class="btn btn-link p-0 text-decoration-none" (click)="setSort('turno')">
              <span [class.fw-semibold]="sortKey==='turno'">Turno</span>
              <i class="mdi" [ngClass]="sortKey==='turno' ? (sortDir==='asc' ? 'mdi-arrow-up' : 'mdi-arrow-down') : 'mdi-arrow-up-down'"></i>
            </button>
          </th>
          <th class="th-nowrap">
            <button type="button" class="btn btn-link p-0 text-decoration-none" (click)="setSort('gerencia')">
              <span [class.fw-semibold]="sortKey==='gerencia'">Gerência</span>
              <i class="mdi" [ngClass]="sortKey==='gerencia' ? (sortDir==='asc' ? 'mdi-arrow-up' : 'mdi-arrow-down') : 'mdi-arrow-up-down'"></i>
            </button>
          </th>
          <th class="th-nowrap text-end">Ações</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let a of pagedAgentes">
          <td>{{ a.matricula }}</td>
          <td>{{ a.nome }}</td>
          <td>{{ a.cargo }}</td>
          <td>{{ a.turno }}</td>
          <td>{{ a.gerencia }}</td>
          <td class="text-end">
            <a class="btn btn-sm btn-outline-secondary me-1" [routerLink]="['/agente', a.matricula, 'editar']"><i class="mdi mdi-pencil-outline"></i></a>
            <button type="button" class="btn btn-sm btn-outline-danger" (click)="prepareDelete(a)" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal"><i class="mdi mdi-trash-can-outline"></i></button>
          </td>
        </tr>
        <tr *ngIf="agentesFiltrados.length === 0">
          <td colspan="6" class="empty-state">Nenhum agente encontrado</td>
        </tr>
      </tbody>
    </table>
  </div>
  
  <!-- Controles de paginação -->
  <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-2 py-3">
    <div class="text-muted small">
      Mostrando {{ totalItems ? (pageStart + 1) : 0 }}–{{ pageEnd }} de {{ totalItems }}
    </div>
    <div class="d-flex align-items-center gap-2">
      <label class="form-label me-2 mb-0" for="pageSizeSelect">Itens por página</label>
      <select id="pageSizeSelect" class="form-select form-select-sm w-auto" [(ngModel)]="pageSize" (ngModelChange)="onPageSizeChange()" name="pageSize">
        <option *ngFor="let opt of pageSizeOptions" [ngValue]="opt">{{ opt }}</option>
      </select>
      <div class="btn-group ms-2" role="group" aria-label="Paginação">
        <button type="button" class="btn btn-outline-secondary btn-sm" (click)="setPage(1)" [disabled]="currentPage <= 1" aria-label="Primeira página"><i class="mdi mdi-chevron-double-left"></i></button>
        <button type="button" class="btn btn-outline-secondary btn-sm" (click)="prevPage()" [disabled]="currentPage <= 1" aria-label="Página anterior"><i class="mdi mdi-chevron-left"></i></button>
        <ng-container *ngFor="let p of pageNumbers">
          <button *ngIf="p !== -1" type="button" class="btn btn-sm" [ngClass]="p === currentPage ? 'btn-primary' : 'btn-outline-secondary'" [attr.aria-current]="p === currentPage ? 'page' : null" (click)="setPage(p)">{{ p }}</button>
          <span *ngIf="p === -1" class="btn btn-outline-secondary btn-sm disabled" aria-hidden="true">…</span>
        </ng-container>
        <button type="button" class="btn btn-outline-secondary btn-sm" (click)="nextPage()" [disabled]="currentPage >= totalPages" aria-label="Próxima página"><i class="mdi mdi-chevron-right"></i></button>
        <button type="button" class="btn btn-outline-secondary btn-sm" (click)="setPage(totalPages)" [disabled]="currentPage >= totalPages" aria-label="Última página"><i class="mdi mdi-chevron-double-right"></i></button>
      </div>
    </div>
  </div>
  </ng-container>
  
  <!-- Modal de confirmação de exclusão -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmDeleteLabel">Confirmar exclusão</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          Tem certeza que deseja excluir o agente <strong>{{ selectedNome }}</strong> (Matrícula {{ selectedMatricula }})?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" (click)="confirmDelete()" data-bs-dismiss="modal">Excluir</button>
        </div>
      </div>
    </div>
  </div>
</div>
