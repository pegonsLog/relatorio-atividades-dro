<div class="produtividade-form-container">
  <div class="form-header">
    <h2 class="mb-0">{{ isEditMode ? 'Editar Item de Produtividade' : 'Novo Item de Produtividade' }}</h2>
    <div class="ms-auto" *ngIf="idRelatorio && idRelatorio > 0">
      <a class="btn btn-sm btn-outline-secondary" [routerLink]="['/relatorio-base', idRelatorio]">
        <i class="mdi mdi-arrow-left me-1"></i>
        Voltar ao Relatório
      </a>
    </div>
  </div>

  <!-- Aviso de contexto ausente -->
  <div *ngIf="!hasContext" class="alert alert-warning" role="alert">
    Este item precisa estar associado a um <strong>Relatório</strong> e a uma <strong>Atividade</strong>.
    Volte para a lista a partir do contexto correto ou informe os parâmetros na URL (?idRelatorio=...&idAtividade=...).
  </div>

  <!-- Resumo do contexto -->
  <div *ngIf="hasContext" class="mb-3 text-muted">
    <small>Contexto: Relatório #{{ idRelatorio }} · Atividade #{{ idAtividade }}</small>
  </div>

  <form [formGroup]="produtividadeForm" (ngSubmit)="onSubmit()" class="produtividade-form">
    <div class="form-row">
      <div class="form-group">
        <label for="codProd">Código do Produto *</label>
        <select id="codProd" formControlName="codProd" class="form-control"
                [class.is-invalid]="isFieldInvalid('codProd')" (change)="onCodigoProdutoChange()">
          <option value="">Selecione um produto</option>
          <option *ngFor="let produto of codigosProdutos" [value]="produto.codigo">
            {{ produto.codigo }} - {{ produto.descricao }}
          </option>
        </select>
        <div class="invalid-feedback" *ngIf="isFieldInvalid('codProd')">
          {{ getFieldError('codProd') }}
        </div>
      </div>

      <div class="form-group">
        <label for="qtdProd">Quantidade Produzida *</label>
        <input type="number" id="qtdProd" formControlName="qtdProd" class="form-control"
               [class.is-invalid]="isFieldInvalid('qtdProd')" 
               placeholder="Digite a quantidade" min="1">
        <div class="invalid-feedback" *ngIf="isFieldInvalid('qtdProd')">
          {{ getFieldError('qtdProd') }}
        </div>
      </div>
    </div>

    <div class="produto-info" *ngIf="produtividadeForm.get('codProd')?.value">
      <div class="info-card">
        <h4>Produto Selecionado</h4>
        <p><strong>Código:</strong> {{ produtividadeForm.get('codProd')?.value }}</p>
        <p><strong>Descrição:</strong> {{ getDescricaoProduto(produtividadeForm.get('codProd')?.value) }}</p>
      </div>
    </div>

    <div class="form-actions">
      <button type="button" class="btn btn-secondary" (click)="onCancel()">
        Cancelar
      </button>
      <button type="submit" class="btn btn-primary" [disabled]="produtividadeForm.invalid || !hasContext">
        {{ isEditMode ? 'Atualizar' : 'Salvar' }}
      </button>
    </div>
  </form>
</div>
