<div class="page-container" *ngIf="relatorio; else carregando">
  <div class="page-header">
    <div class="page-title">
      <h1>Relatório Diário 
        <!-- #{{ relatorio.idRelatorio }} -->
      </h1>
      <p class="page-subtitle">Detalhes e atividades do relatório</p>
    </div>
    <div class="page-actions">
      <a class="btn btn-outline-secondary" [routerLink]="['/relatorio-base']" [queryParamsHandling]="'preserve'">
        <hero-icon name="arrow-left" size="1.125rem"></hero-icon>
        <span class="d-none d-sm-inline">Voltar</span>
      </a>
      <a class="btn btn-outline-secondary" [routerLink]="['/menu']">
        <hero-icon name="home" size="1.125rem"></hero-icon>
        <span class="d-none d-sm-inline">Menu</span>
      </a>
    </div>
  </div>

  <!-- Resumo do Relatório -->
  <div class="card summary-card">
    <div class="card-body">
      <div class="summary-grid">
        <div class="summary-item">
          <span class="summary-label">Data</span>
          <span class="summary-value">{{ relatorio!.data | date:'dd/MM/yyyy' }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Dia da Semana</span>
          <span class="summary-value">{{ relatorio!.diaSemana }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Gerência</span>
          <span class="summary-value badge badge-info">{{ relatorio!.gerencia }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Turno</span>
          <span class="summary-value badge badge-success">{{ relatorio!.turno }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Mat. 1</span>
          <span class="summary-value">{{ relatorio!.mat1 }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Mat. 2</span>
          <span class="summary-value">{{ relatorio!.mat2 || '-' }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Coord.</span>
          <span class="summary-value">{{ relatorio!.coord }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Superv.</span>
          <span class="summary-value">{{ relatorio!.superv }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Ações -->
  <div class="section-actions" *ngIf="podeEditar">
    <button class="btn btn-primary" (click)="abrirForm()">
      <hero-icon name="plus" size="1.125rem"></hero-icon>
      Adicionar Atividade
    </button>
  </div>

  <!-- Formulário de Item Atividade -->
  <div class="card form-card" *ngIf="showForm">
    <div class="card-header">
      <span>{{ editAtividade ? 'Editar atividade' : 'Nova atividade' }}</span>
      <button class="btn btn-sm btn-ghost" (click)="fecharForm()">
        <hero-icon name="x-mark" size="1.125rem"></hero-icon>
        Fechar
      </button>
    </div>
    <div class="card-body">
      <app-item-atividade-form [idRelatorio]="idRelatorio" [dataRelatorio]="relatorio!.data"
        [atividade]="editAtividade || undefined" [isEditMode]="!!editAtividade" (formSubmit)="onAtividadeCriada($event)"
        (formCancel)="fecharForm()"></app-item-atividade-form>
    </div>
  </div>

  <!-- Cards das atividades -->
  <div class="section-header">
    <h3>
      <hero-icon name="table-cells" size="1.25rem"></hero-icon>
      Atividades
    </h3>
    <span class="badge badge-count">{{ atividadesOrdenadas.length }}</span>
  </div>

  <div class="items-grid">
    <div class="empty-state" *ngIf="atividadesOrdenadas.length === 0">
      <hero-icon name="document" size="3rem" class="empty-icon"></hero-icon>
      <p>Nenhuma atividade adicionada ainda</p>
    </div>

    <div class="item-card" *ngFor="let a of atividadesOrdenadas">
      <div class="item-card-header">
        <div class="item-id">Item {{ a.item }}</div>
        <div class="item-badge">
          <span class="badge badge-info">{{ a.codAtv }}</span>
          <span class="item-name" *ngIf="a.nomeAtividade">{{ a.nomeAtividade }}</span>
        </div>
      </div>
      <div class="item-card-body">
        <div class="item-row">
          <div class="item-stat">
            <span class="stat-label">Data</span>
            <span class="stat-value">{{ a.data | date:'dd/MM/yyyy' }}</span>
          </div>
          <div class="item-stat">
            <span class="stat-label">Agentes</span>
            <span class="stat-value">{{ a.qtdAgentes }}</span>
          </div>
        </div>
        <div class="item-row">
          <div class="item-stat">
            <span class="stat-label">Chegada</span>
            <span class="stat-value">{{ a.chegada | date:'HH:mm' }}</span>
          </div>
          <div class="item-stat">
            <span class="stat-label">Solução</span>
            <span class="stat-value">{{ a.solucao ? (a.solucao | date:'HH:mm') : '-' }}</span>
          </div>
          <div class="item-stat">
            <span class="stat-label">Saída</span>
            <span class="stat-value">{{ a.saida | date:'HH:mm' }}</span>
          </div>
        </div>
        <div class="item-local" *ngIf="a.local">
          <span class="stat-label">Local:</span>
          <span>{{ a.local }}</span>
        </div>
        <div class="item-obs" *ngIf="a.observacoes">
          <span class="stat-label">Obs.:</span>
          <span>{{ a.observacoes }}</span>
        </div>
        <div class="item-badges">
          <span class="badge badge-purple">
            <hero-icon name="chart-bar" size="0.875rem"></hero-icon>
            {{ getQtdProd(a) }} Produtividades
          </span>
          <span class="badge badge-yellow">
            <hero-icon name="exclamation-circle" size="0.875rem"></hero-icon>
            {{ getQtdOcor(a) }} Ocorrências
          </span>
        </div>
      </div>
      <div class="item-card-actions">
        <a class="btn btn-sm btn-success" [routerLink]="['/item-atividade', a.idAtividade]"
          [queryParamsHandling]="'preserve'">
          <hero-icon name="eye" size="1rem"></hero-icon>
          Ver Detalhes
        </a>
        <button class="btn btn-sm btn-ghost" (click)="editarAtividade(a)" *ngIf="podeEditar">
          <hero-icon name="pencil" size="1rem"></hero-icon>
          Editar
        </button>
        <button class="btn btn-sm btn-ghost-danger" (click)="openDelete(a.idAtividade)" *ngIf="podeEditar">
          <hero-icon name="trash" size="1rem"></hero-icon>
          Excluir
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de exclusão -->
  <div class="modal-overlay" *ngIf="showDeleteModal" (click)="closeDelete()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-icon modal-icon-danger">
          <hero-icon name="exclamation-triangle" size="1.5rem"></hero-icon>
        </div>
        <h3>Confirmar exclusão</h3>
        <button type="button" class="btn btn-icon btn-ghost modal-close" (click)="closeDelete()" [disabled]="deleting">
          <hero-icon name="x-mark" size="1.25rem"></hero-icon>
        </button>
      </div>
      <div class="modal-body">
        <p>Tem certeza que deseja excluir a atividade <strong>{{ toDelete }}</strong>?</p>
        <p class="text-muted">Esta ação removerá também as produtividades vinculadas.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDelete()" [disabled]="deleting">Cancelar</button>
        <button type="button" class="btn btn-danger" (click)="confirmDelete()" [disabled]="deleting">
          <span *ngIf="!deleting">Excluir</span>
          <span *ngIf="deleting" class="btn-loading"><span class="spinner-sm"></span>Excluindo...</span>
        </button>
      </div>
    </div>
  </div>
</div>

<ng-template #carregando>
  <div class="loading-container">
    <div class="spinner"></div>
    <span>Carregando...</span>
  </div>
</ng-template>