<div class="atividade-form-container">
  <div class="form-header">
    <h2>{{ isEditMode ? 'Editar Atividade' : 'Nova Atividade' }}</h2>
    <div class="small text-muted" *ngIf="dataRelatorio as d">
      Data do relatório: <strong>{{ d | date:'EEE, dd/MM/yyyy' }}</strong>
    </div>
  </div>

  <form [formGroup]="atividadeForm" (ngSubmit)="onSubmit()" class="atividade-form">
    <div class="form-row">
      <div class="form-group">
        <label for="item">Item *</label>
        <input type="number" id="item" formControlName="item" class="form-control"
               [class.is-invalid]="isFieldInvalid('item')" placeholder="Número do item">
        <div class="invalid-feedback" *ngIf="isFieldInvalid('item')">
          {{ getFieldError('item') }}
        </div>
      </div>

      <div class="form-group">
        <label for="acionamento">Tipo de Acionamento *</label>
        <select id="acionamento" formControlName="acionamento" class="form-control"
                [class.is-invalid]="isFieldInvalid('acionamento')">
          <option value="">Selecione o tipo</option>
          <option *ngFor="let tipo of tiposAcionamento" [value]="tipo">{{ tipo }}</option>
        </select>
        <div class="invalid-feedback" *ngIf="isFieldInvalid('acionamento')">
          {{ getFieldError('acionamento') }}
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="chegada">Horário de Chegada *</label>
        <input type="time" id="chegada" formControlName="chegada" class="form-control"
               [class.is-invalid]="isFieldInvalid('chegada')" (change)="validateHorarios()">
        <div class="invalid-feedback" *ngIf="isFieldInvalid('chegada')">
          {{ getFieldError('chegada') }}
        </div>
      </div>

      <div class="form-group">
        <label for="solucao">Horário da Solução *</label>
        <input type="time" id="solucao" formControlName="solucao" class="form-control"
               [class.is-invalid]="isFieldInvalid('solucao')" (change)="validateHorarios()">
        <div class="invalid-feedback" *ngIf="isFieldInvalid('solucao')">
          {{ getFieldError('solucao') }}
          <span *ngIf="atividadeForm.get('solucao')?.errors?.['invalidTime']">
            Horário deve ser posterior à chegada
          </span>
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="saida">Horário de Saída *</label>
        <input type="time" id="saida" formControlName="saida" class="form-control"
               [class.is-invalid]="isFieldInvalid('saida')" (change)="validateHorarios()">
        <div class="invalid-feedback" *ngIf="isFieldInvalid('saida')">
          {{ getFieldError('saida') }}
          <span *ngIf="atividadeForm.get('saida')?.errors?.['invalidTime']">
            Horário deve ser posterior à solução
          </span>
        </div>
      </div>

      <div class="form-group">
        <label for="qtdAgentes">Quantidade de Agentes *</label>
        <input type="number" id="qtdAgentes" formControlName="qtdAgentes" class="form-control"
               [class.is-invalid]="isFieldInvalid('qtdAgentes')" placeholder="Número de agentes">
        <div class="invalid-feedback" *ngIf="isFieldInvalid('qtdAgentes')">
          {{ getFieldError('qtdAgentes') }}
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="codAtv">Código da Atividade *</label>
        <input type="number" id="codAtv" formControlName="codAtv" class="form-control"
               [class.is-invalid]="isFieldInvalid('codAtv')" placeholder="Código da atividade">
        <div class="invalid-feedback" *ngIf="isFieldInvalid('codAtv')">
          {{ getFieldError('codAtv') }}
        </div>
      </div>

      <div class="form-group">
        <label for="codOcor">Código da Ocorrência *</label>
        <input type="number" id="codOcor" formControlName="codOcor" class="form-control"
               [class.is-invalid]="isFieldInvalid('codOcor')" placeholder="Código da ocorrência">
        <div class="invalid-feedback" *ngIf="isFieldInvalid('codOcor')">
          {{ getFieldError('codOcor') }}
        </div>
      </div>
    </div>

    <div class="form-row full-width">
      <div class="form-group">
        <label for="local">Local *</label>
        <input type="text" id="local" formControlName="local" class="form-control"
               [class.is-invalid]="isFieldInvalid('local')" placeholder="Descrição do local da atividade">
        <div class="invalid-feedback" *ngIf="isFieldInvalid('local')">
          {{ getFieldError('local') }}
        </div>
      </div>
    </div>

    <div class="form-row full-width">
      <div class="form-group">
        <label for="observacoes">Observações</label>
        <textarea id="observacoes" formControlName="observacoes" class="form-control textarea"
                  [class.is-invalid]="isFieldInvalid('observacoes')" 
                  placeholder="Observações sobre a atividade (máximo 500 caracteres)"
                  rows="4" maxlength="500"></textarea>
        <div class="char-counter">
          {{ atividadeForm.get('observacoes')?.value?.length || 0 }}/500
        </div>
        <div class="invalid-feedback" *ngIf="isFieldInvalid('observacoes')">
          {{ getFieldError('observacoes') }}
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button type="button" class="btn btn-secondary" (click)="onCancel()">
        Cancelar
      </button>
      <button type="submit" class="btn btn-primary" [disabled]="atividadeForm.invalid">
        {{ isEditMode ? 'Atualizar' : 'Salvar' }}
      </button>
    </div>
  </form>
</div>
