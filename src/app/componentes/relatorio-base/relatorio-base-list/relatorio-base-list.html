<div class="container py-4">
  <div class="page-header">
    <div class="header-content">
      <h1>Relatórios Base</h1>
      <p>Gerencie os relatórios diários do sistema</p>
    </div>
    <div class="header-actions">
      <a class="btn btn-outline-secondary" [routerLink]="['/menu']">
        <hero-icon name="home" size="1.25rem"></hero-icon>
        Voltar ao Menu
      </a>
    </div>
  </div>

  <div class="content-grid">
    <!-- Formulário -->
    <div class="form-section" #formTop>
      <div class="section-card">
        <div class="section-header">
          <hero-icon [name]="selected?.idRelatorio ? 'pencil-square' : 'document-text'" size="1.25rem"></hero-icon>
          <span>{{ selected?.idRelatorio ? 'Editar Relatório' : 'Novo Relatório' }}</span>
        </div>
        <div class="section-body">
          <app-relatorio-base-form [value]="selected" [defaults]="{ gerencia: defaultGerencia, turno: defaultTurno }"
            [saving]="saving" (submitValue)="onSubmit($event)" (cancel)="cancel()"></app-relatorio-base-form>
        </div>
      </div>
    </div>

    <!-- Lista -->
    <div class="list-section">
      <div class="section-card">
        <div class="section-header">
          <hero-icon name="document-duplicate" size="1.25rem"></hero-icon>
          <span>Lista de Relatórios</span>
        </div>

        <div class="search-bar">
          <div class="search-input">
            <hero-icon name="magnifying-glass" size="1.25rem"></hero-icon>
            <input type="text" class="form-control" [(ngModel)]="filtro" (ngModelChange)="onFilterChange()"
              name="filtro" placeholder="Buscar por data, matrícula, coordenação ou supervisor..." />
            <button class="btn-clear" type="button" (click)="clearFilter()" *ngIf="filtro.trim()">
              <hero-icon name="x-circle" size="1.25rem"></hero-icon>
            </button>
          </div>
        </div>

        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>
                  <button type="button" class="sort-btn" (click)="setSort('data')">
                    Data
                    <hero-icon
                      [name]="sortKey==='data' ? (sortDir==='asc' ? 'arrow-up' : 'arrow-down') : 'arrows-up-down'"
                      size="0.875rem"></hero-icon>
                  </button>
                </th>
                <th>
                  <button type="button" class="sort-btn" (click)="setSort('gerencia')">
                    Gerência
                    <hero-icon
                      [name]="sortKey==='gerencia' ? (sortDir==='asc' ? 'arrow-up' : 'arrow-down') : 'arrows-up-down'"
                      size="0.875rem"></hero-icon>
                  </button>
                </th>
                <th>
                  <button type="button" class="sort-btn" (click)="setSort('turno')">
                    Turno
                    <hero-icon
                      [name]="sortKey==='turno' ? (sortDir==='asc' ? 'arrow-up' : 'arrow-down') : 'arrows-up-down'"
                      size="0.875rem"></hero-icon>
                  </button>
                </th>
                <th>
                  <button type="button" class="sort-btn" (click)="setSort('mat1')">
                    Mat. 1
                    <hero-icon
                      [name]="sortKey==='mat1' ? (sortDir==='asc' ? 'arrow-up' : 'arrow-down') : 'arrows-up-down'"
                      size="0.875rem"></hero-icon>
                  </button>
                </th>
                <th>
                  <button type="button" class="sort-btn" (click)="setSort('mat2')">
                    Mat. 2
                    <hero-icon
                      [name]="sortKey==='mat2' ? (sortDir==='asc' ? 'arrow-up' : 'arrow-down') : 'arrows-up-down'"
                      size="0.875rem"></hero-icon>
                  </button>
                </th>
                <th>
                  <button type="button" class="sort-btn" (click)="setSort('coord')">
                    Coord.
                    <hero-icon
                      [name]="sortKey==='coord' ? (sortDir==='asc' ? 'arrow-up' : 'arrow-down') : 'arrows-up-down'"
                      size="0.875rem"></hero-icon>
                  </button>
                </th>
                <th>
                  <button type="button" class="sort-btn" (click)="setSort('superv')">
                    Superv.
                    <hero-icon
                      [name]="sortKey==='superv' ? (sortDir==='asc' ? 'arrow-up' : 'arrow-down') : 'arrows-up-down'"
                      size="0.875rem"></hero-icon>
                  </button>
                </th>
                <th>Status</th>
                <th>Criado por</th>
                <th class="text-end">Ações</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let r of pageItems" (dblclick)="startEdit(r)" class="cursor-pointer">
                <td>{{ r.data | date:'dd/MM/yyyy' }}</td>
                <td><span class="badge text-bg-primary">{{ r.gerencia }}</span></td>
                <td><span class="badge text-bg-secondary">{{ r.turno }}</span></td>
                <td>{{ r.mat1 }}</td>
                <td>{{ r.mat2 }}</td>
                <td>{{ r.coord }}</td>
                <td>{{ r.superv }}</td>
                <td>
                  <span class="badge" [ngClass]="r.status === 'lido' ? 'text-bg-success' : 'text-bg-warning'">
                    {{ r.status === 'lido' ? 'Lido' : 'Pendente' }}
                  </span>
                </td>
                <td class="text-muted">{{ r.criadoPor || '-' }}</td>
                <td class="text-end">
                  <div class="action-buttons">
                    <a class="btn btn-sm btn-outline-info" [routerLink]="['/relatorio-base', r.idRelatorio!]"
                      [queryParamsHandling]="'preserve'" title="Detalhe">
                      <hero-icon name="eye" size="1rem"></hero-icon>
                    </a>
                    <button class="btn btn-sm btn-outline-primary" (click)="startEdit(r)" title="Editar" *ngIf="r.status !== 'lido'">
                      <hero-icon name="pencil" size="1rem"></hero-icon>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" (click)="openDelete(r.idRelatorio!)" title="Excluir" *ngIf="r.status !== 'lido'">
                      <hero-icon name="trash" size="1rem"></hero-icon>
                    </button>
                  </div>
                </td>
              </tr>
              <tr *ngIf="filtrados.length === 0">
                <td colspan="10" class="empty-state">
                  <hero-icon name="document-duplicate" size="3rem"></hero-icon>
                  <p>Nenhum relatório encontrado</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="pagination-bar">
          <div class="pagination-info">
            Mostrando {{ startIndex }}–{{ endIndex }} de {{ total }}
          </div>
          <div class="pagination-controls">
            <div class="page-size">
              <label>Por página</label>
              <select class="form-select form-select-sm" [(ngModel)]="pageSize" name="pageSize"
                (ngModelChange)="goTo(1)">
                <option *ngFor="let s of pageSizes" [value]="s">{{ s }}</option>
              </select>
            </div>
            <nav class="pagination-nav">
              <button class="btn btn-sm btn-outline-secondary" (click)="goTo(page - 1)" [disabled]="page === 1">
                <hero-icon name="chevron-left" size="1rem"></hero-icon>
              </button>
              <button *ngFor="let p of pages" class="btn btn-sm"
                [ngClass]="p === page ? 'btn-primary' : 'btn-outline-secondary'" (click)="goTo(p)">{{ p }}</button>
              <button class="btn btn-sm btn-outline-secondary" (click)="goTo(page + 1)"
                [disabled]="page === totalPages">
                <hero-icon name="chevron-right" size="1rem"></hero-icon>
              </button>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirmação de exclusão -->
  <div *ngIf="showDeleteModal" class="modal-overlay" (click)="closeDelete()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-icon danger">
          <hero-icon name="exclamation-triangle" size="1.5rem"></hero-icon>
        </div>
        <div>
          <h5 class="modal-title">Confirmar exclusão</h5>
          <p class="modal-subtitle">Esta ação não pode ser desfeita</p>
        </div>
        <button type="button" class="modal-close" (click)="closeDelete()" [disabled]="deleting">
          <hero-icon name="x-mark" size="1.5rem"></hero-icon>
        </button>
      </div>
      <div class="modal-body">
        <p>Tem certeza que deseja excluir o relatório <strong>{{ toDelete }}</strong>?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" (click)="closeDelete()"
          [disabled]="deleting">Cancelar</button>
        <button type="button" class="btn btn-danger" (click)="confirmDelete()" [disabled]="deleting">
          <span *ngIf="!deleting" class="d-flex align-items-center gap-2">
            <hero-icon name="trash" size="1.25rem"></hero-icon>
            Excluir
          </span>
          <span *ngIf="deleting" class="d-flex align-items-center gap-2">
            <span class="spinner-border spinner-border-sm"></span>
            Excluindo...
          </span>
        </button>
      </div>
    </div>
  </div>
</div>